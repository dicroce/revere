app-id: io.github.dicroce.Revere
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: revere

finish-args:
  # Display access for GUI (SDL2 supports both X11 and Wayland)
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri

  # Network access for RTSP cameras and ONVIF discovery
  - --share=network

  # Storage in ~/Documents/revere
  - --filesystem=xdg-documents/revere:create

  # System tray support (StatusNotifierItem protocol)
  - --talk-name=org.kde.StatusNotifierWatcher

  # Environment variables for GStreamer plugin discovery
  - --env=GST_PLUGIN_PATH=/app/lib/gstreamer-1.0

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - /share/doc
  - /share/man
  - /share/gtk-doc
  - '*.la'
  - '*.a'

modules:
  # ============================================
  # Module 1: NCNN (Neural Network Inference)
  # Required for YOLOv8 AI object detection
  # ============================================
  - name: ncnn
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - -DNCNN_BUILD_EXAMPLES=OFF
      - -DNCNN_BUILD_TOOLS=OFF
      - -DNCNN_BUILD_BENCHMARK=OFF
      - -DNCNN_BUILD_TESTS=OFF
      - -DNCNN_SHARED_LIB=OFF
      - -DNCNN_OPENMP=ON
      - -DNCNN_VULKAN=OFF
      - -DNCNN_PIXEL=ON
      - -DNCNN_PIXEL_ROTATE=ON
      - -DNCNN_PIXEL_AFFINE=ON
      - -DNCNN_PIXEL_DRAWING=ON
    sources:
      - type: git
        url: https://github.com/Tencent/ncnn.git
        commit: 1e88fb8d5b03fedc813dd54bff34d42f65650281

  # ============================================
  # Module 2: OpenCV with Contrib Modules
  # Must be built from source for contrib modules
  # (bgsegm, tracking, optflow, etc.)
  # ============================================
  - name: opencv
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DOPENCV_EXTRA_MODULES_PATH=/run/build/opencv/contrib/modules
      - -DBUILD_LIST=core,imgproc,imgcodecs,video,videoio,calib3d,features2d,flann,dnn,bgsegm,tracking,optflow,ximgproc,xfeatures2d,plot
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTS=OFF
      - -DBUILD_PERF_TESTS=OFF
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_DOCS=OFF
      - -DBUILD_opencv_apps=OFF
      - -DBUILD_opencv_python2=OFF
      - -DBUILD_opencv_python3=OFF
      - -DWITH_FFMPEG=ON
      - -DWITH_GSTREAMER=ON
      - -DWITH_GTK=OFF
      - -DWITH_QT=OFF
      - -DWITH_OPENGL=ON
      - -DWITH_TBB=OFF
      - -DWITH_IPP=OFF
      - -DWITH_LAPACK=OFF
      - -DOPENCV_ENABLE_NONFREE=OFF
      - -DENABLE_PRECOMPILED_HEADERS=OFF
    sources:
      - type: archive
        url: https://github.com/opencv/opencv/archive/refs/tags/4.10.0.tar.gz
        sha256: b2171af5be6b26f7a06b1229948bbb2bdaa74fcf5cd097e0af6378fce50a6eb9
      - type: archive
        url: https://github.com/opencv/opencv_contrib/archive/refs/tags/4.10.0.tar.gz
        sha256: 65597f8fb8dc2b876c1b45b928bbcc5f772ddbaf97539bf1b737623d0604cba1
        dest: contrib

  # ============================================
  # Module 3: GStreamer RTSP Server
  # May not be included in freedesktop runtime
  # ============================================
  - name: gst-rtsp-server
    buildsystem: meson
    builddir: true
    config-opts:
      - -Ddoc=disabled
      - -Dexamples=disabled
      - -Dtests=disabled
      - -Dintrospection=disabled
    sources:
      - type: archive
        url: https://gstreamer.freedesktop.org/src/gst-rtsp-server/gst-rtsp-server-1.24.10.tar.xz
        sha256: db21dfdd7bf2e718564d557378ada5358b411efe2a3e89e9f0f87a74537e2adc

  # ============================================
  # Module 4: libdbusmenu (required by ayatana-appindicator)
  # ============================================
  # Shared modules for appindicator support (from flathub/shared-modules)
  - shared-modules/intltool/intltool-0.51.json
  - shared-modules/libappindicator/libappindicator-gtk3-12.10.json

  # ============================================
  # Module 5: Revere Application
  # ============================================
  - name: revere
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      # Tell CMake where to find pre-fetched FetchContent dependencies
      - -DFETCHCONTENT_SOURCE_DIR_NANOTS=/run/build/revere/deps/nanots
      - -DFETCHCONTENT_SOURCE_DIR_PUGIXML=/run/build/revere/deps/pugixml
      - -DFETCHCONTENT_SOURCE_DIR_TRAYPP=/run/build/revere/deps/traypp
      - -DFETCHCONTENT_SOURCE_DIR_SDL2=/run/build/revere/deps/sdl2
      - -DFETCHCONTENT_SOURCE_DIR_MBEDTLS=/run/build/revere/deps/mbedtls
      # Disable PipeWire in SDL2 (SDK 25.08 has incompatible version)
      - -DSDL_PIPEWIRE=OFF
    build-options:
      env:
        NCNN_TOP_DIR: /app
        OPENCV_TOP_DIR: /app
    sources:
      - type: dir
        path: ..
      # Pre-fetch FetchContent dependencies (pinned to commits for reproducibility)
      - type: git
        url: https://github.com/dicroce/nanots.git
        commit: 32185faebab39220925393a4f4ef403e026891e2
        dest: deps/nanots
      - type: git
        url: https://github.com/zeux/pugixml.git
        commit: ee86beb30e4973f5feffe3ce63bfa4fbadf72f38
        dest: deps/pugixml
      - type: git
        url: https://github.com/dicroce/traypp.git
        commit: 13da575044ff10be98d832a9198204d36d2bbec4
        dest: deps/traypp
      - type: patch
        path: traypp-libappindicator.patch
        options:
          - -d
          - deps/traypp
      - type: git
        url: https://github.com/libsdl-org/SDL.git
        tag: release-2.32.2
        dest: deps/sdl2
      - type: git
        url: https://github.com/Mbed-TLS/mbedtls.git
        tag: v3.6.3
        dest: deps/mbedtls
